<div class="grafico">
  <div class="grafico-titulo">
    <span class="grafico-label">Score consolidado</span>
    <!--<span class="etiqueta-invertida">Final</span>-->
  </div>

  <div class="gauge-wrapper" style="height: 180px;">
    <canvas id="gaugePonteiro_consolidado" style="height: 100%; width: 100%;"></canvas>
  </div>

  <div id="label_ponteiro" class="classificacao">{{ $json.consolidado.classificacao }}</div>
  
  <div class="tooltip">
    <svg xmlns="http://www.w3.org/2000/svg"
       width="22" height="22" viewBox="0 0 24 24"
       fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
       class="info-icon">
      <circle cx="12" cy="12" r="10" />
      <line x1="12" y1="16" x2="12" y2="12" />
      <line x1="12" y1="8" x2="12.01" y2="8" />
  </svg>
    <span class="tooltip-text">{{ $json.consolidado.racional }}</span>
  </div>
</div>

<script>
(function waitForCanvas() {
  const canvas = document.getElementById('gaugePonteiro_consolidado');
  if (!canvas || !canvas.getContext) {
    return requestAnimationFrame(waitForCanvas);
  }

  const scoreReal = {{ $json.consolidado.score }};
  const score = scoreReal * 10;
  const ctx = canvas.getContext('2d');

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Score'],
      datasets: [{
        data: [100],
        backgroundColor: ['#0000'],
        borderWidth: 0,
        cutout: '80%',
      }]
    },
    options: {
      responsive: true,
      rotation: -Math.PI,
      circumference: Math.PI,
      cutout: '80%',
      plugins: {
        tooltip: { enabled: false },
        legend: { display: false }
      },
    },
    plugins: [{
      id: 'customGauge',
      afterDraw: (chart) => {
        const ctx = chart.ctx;
        const angle = (score / 100) * Math.PI;
        const cx = chart.width / 2;
        const cy = chart.height - 40; // ⬆️ sobe tudo no gráfico
        const r = chart.width / 2.2;

        ctx.save();

        const drawArc = (start, end, color) => {
          ctx.beginPath();
          ctx.arc(cx, cy, r, start, end);
          ctx.strokeStyle = color;
          ctx.lineWidth = 16;
          ctx.lineCap = "round";
          ctx.stroke();
        };

        drawArc(Math.PI, Math.PI + Math.PI * 0.2, "#f44336");      // vermelho
        drawArc(Math.PI + Math.PI * 0.2, Math.PI + Math.PI * 0.4, "#ff5722");   // laranja escuro
        drawArc(Math.PI + Math.PI * 0.4, Math.PI + Math.PI * 0.6, "#ff9800");   // laranja claro
        drawArc(Math.PI + Math.PI * 0.6, Math.PI + Math.PI * 0.8, "#9acb82");   // verde limão
        drawArc(Math.PI + Math.PI * 0.8, 2 * Math.PI, "#4caf50");   // verde forte


        const x = cx + r * Math.cos(Math.PI + angle);
        const y = cy + r * Math.sin(Math.PI + angle);
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 5;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, 2 * Math.PI);
        ctx.fillStyle = '#ccc';
        ctx.fill();

        // 🔢 Texto central
        ctx.font = "bold 20px Arial";
        ctx.fillStyle = "#888";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(score.toFixed(0), cx, cy - 30);

        // 🔢 Extremidades 0 e 100 alinhadas ao arco
        ctx.font = "bold 12px Arial";
        ctx.fillStyle = "#888";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // "0" à esquerda (início do arco)
        const x0 = cx + r * Math.cos(Math.PI);
        const y0 = cy + r * Math.sin(Math.PI);
        ctx.fillText("0", x0, y0 + 20);
        
        // "100" à direita (fim do arco)
        const x100 = cx + r * Math.cos(0);
        const y100 = cy + r * Math.sin(0);
        ctx.fillText("100", x100 -6, y100 + 20);

        ctx.restore();
      }
    }]
  });
})();
</script>

<style>
  .grafico-titulo {
    margin-bottom: 10px;
    font-size: 15px;
    font-weight: bold;
    color: #f7931a;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .grafico-label {
    font-size: 16px;
    font-weight: 600;
  }

  .etiqueta-invertida {
    background-color: #fff;
    color: #f7931a;
    font-weight: bold;
    font-size: 13px;
    padding: 2px 8px;
    border-radius: 6px;
  }

  .tooltip {
    position: relative;
    display: inline-block;
    cursor: pointer;
    font-size: 16px;
    color: #aaa;
    margin-top: 10px;
  }

  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }

  .tooltip-text {
    visibility: hidden;
    width: 240px;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 12px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    font-size: 14px;
    line-height: 1.5;
    white-space: normal;
    border: 1px solid #f7931a;
  }
</style>
